<%-include('../layouts/websitehead.ejs')%>

    <!-- Topbar Start -->
    
    <div class="container-fluid bg-dark mb-30">
        <div class="row px-xl-5">
            <div class="col-lg-3 d-none d-lg-block">
                <a class="btn d-flex align-items-center justify-content-between  w-100" data-toggle="collapse" href="#navbar-vertical" style="height: 65px; padding: 0 30px;">
                    <h6 class="text-white m-0"><i class="fa fa-bars mr-2"></i>Categories</h6>
                    <i class="fa fa-angle-down text-white"></i>
                </a>
                <nav class="collapse position-absolute navbar navbar-vertical navbar-light align-items-start p-0 bg-light" id="navbar-vertical" style="width: calc(100% - 30px); z-index: 999;">
                    <div class="navbar-nav w-100">
                       <% for(let i=0 ;i<categoryData.length ;i++){%>
                            <a href="/shop?id=<%= categoryData[i]._id %>" class="nav-item nav-link"><%= categoryData[i].name%></a>
                      <% } %>

                        
                        
                    </div>
                </nav>
            </div>
            <div class="col-lg-9">
                <nav class="navbar navbar-expand-lg bg-dark navbar-dark py-3 py-lg-0 px-0">
                    <a href="" class="text-decoration-none d-block d-lg-none">
                        <span class="h2 text-dark bg-light px-2">Lap</span>
                        <span class="h1 text-uppercase text-light bg-primary px-2 ml-n1">Mania</span>
                    </a>
                    <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarCollapse">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse justify-content-between" id="navbarCollapse">
                        <div class="navbar-nav mr-auto py-0">
                            <a href="/home" class="nav-item nav-link active">Home</a>
                            <a href="/shop" class="nav-item nav-link">Shop</a>
                            <!-- <a href="/detail" class="nav-item nav-link">Shop Detail</a> -->
                            
                            <a href="/contact" class="nav-item nav-link">Contact</a>
                        </div>
                        <div class="navbar-nav ml-auto py-0 d-none d-lg-block">
                            <a href="/profile" class="btn me-4 ">
                                <% if(typeof userData !== 'undefined'){%>
                                        <p class="text-uppercase text-white pt-3 px-4"><%=userData.name%></p>
                               <% } %>
                               
                                
                            </a>
                            <% if(typeof userData !== 'undefined'){%>
                               <a href="/wishlist" class="btn px-0">
                                                                <i class="fas fa-heart text-primary"></i>
                                                                <span class="badge text-secondary border border-secondary rounded-circle" style="padding-bottom: 2px;"><%=wishlistCount%></span>
                                                               
                                                                </a>
                                                            <a href="/cart" class="btn px-0 ml-3">
                                                                <i class="fas fa-shopping-cart text-primary"></i>
                                                                <span class="badge text-secondary border border-secondary rounded-circle" style="padding-bottom: 2px;"><%=cartCount%></span>
                                                                <!-- <span class="cart-badge text-white " style="font-size: small; padding-top: 10px;"><%=cartCount%></span> -->
                                                                
                                                                </a>
                                                               


                        <% }else{%>

                            <a href="/login" class="btn px-0" >
                                <i class="fas fa-heart text-primary"></i>
                                </a>
                            <a href="/login" class="btn px-0 ml-3">
                                <i class="fas fa-shopping-cart text-primary"></i>
                                </a>
        

                       <% } %>
                            
                        </div>
                    </div>
                </nav>
            </div>
        </div>
    </div>

    <!-- Breadcrumb Start -->
    <div class="container-fluid">
        <div class="row px-xl-5">
            <div class="col-12">
                <nav class="breadcrumb bg-light mb-30">
                    <a class="breadcrumb-item text-dark" href="/home">Home</a>
                    <a class="breadcrumb-item text-dark" href="/shop">Shop</a>
                    <span class="breadcrumb-item active">Checkout</span>
                </nav>
            </div>
        </div>
    </div>
    <!-- Breadcrumb End -->


    <!-- Checkout Start -->
    
       
        
    <form  action=""  class="container-fluid" id="checkout_form">
        <div class="row px-xl-5">
            <div class="col-lg-8">
                
                <h5 class="section-title position-relative text-uppercase mb-3"><span class="bg-secondary pr-3">Billing Address</span></h5>
                
                    <div  class="bg-light p-30 mb-5" >
                    <div class="row">
                       
                        
                        <% if(userData.address.length>=0){%>
  
                        
                        <div class="col-md-6 form-group">
                        
                            <label>First Name</label>
                            <input class="form-control" id="name" type="text" name="name" style="color: black;" required >

                        </div>
                        <div class="col-md-6 form-group">
                            <label>Mobile No</label>
                            <input class="form-control" id="mob" type="text" name="mobile" required >
                        </div>
                        <div class="col-md-6 form-group">
                            <label>House/Build.no</label>
                            <input class="form-control" id="house" type="text" name="house" required>
                        </div>
                        <div class="col-md-6 form-group">
                            <label>Street</label>
                            <input class="form-control" id="street" type="text" name="street" required >
                        </div>
                        <div class="col-md-6 form-group">
                            <label>District</label>
                            <input class="form-control" id="district" type="text"  name="district" required>
                        </div>
                        <!-- <div class="col-md-6 form-group">
                            <label>Country</label>
                            <select class="custom-select">
                                <option selected>India</option>
                                <option>Afghanistan</option>
                                <option>Albania</option>
                                <option>Algeria</option>
                            </select>
                        </div> -->
                        <div class="col-md-6 form-group">
                            <label>Country</label>
                            <input class="form-control" id="country"  name="country"  type="text" required>
                        </div>
                        <div class="col-md-6 form-group">
                            <label>City</label>
                            <input class="form-control" id="city" type="text" name="city" required >
                        </div>
                        <div class="col-md-6 form-group">
                            <label>State</label>
                            <input class="form-control" id="state" type="text" name="state" required  >
                        </div>
                        <div class="col-md-6 form-group">
                            <label>ZIP Code</label>
                            <input class="form-control"  id="zip" type="number" name="pinCode" required  >
                        </div>
                       
                       



                        <!-- Button trigger modal -->
<!-- Button trigger modal -->


  <!-- Modal -->
  <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header border-0">
          <!-- <h1 class="modal-title fs-5" id="staticBackdropLabel">Modal title</h1> -->
          <!-- <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> -->
        </div>
        <div class="modal-body">
            <% if( couponData.length>0){ %>
                <% for(let i=0;i<couponData.length;i++){ %>
                    <div class="alert bg-white  d-flex align-items-center col-12 mb-0 text-dark" role="alert"> 
                    <%if(couponData[i].status =='valid'){%>
                        <div class="card w-100" style="height: 6.25rem;" >                           
                            <div class="card-body "> 
                                <h5>code: <%=couponData[i].code%></h5>
                                <h6 style="color: #26a541;">Get additional <%=couponData[i].discount%>% Off up to  <%=couponData[i].maxRedeemAmount%><span class="d-flex justify-content-end" style="color: #2874f0;">View T&C</span></h6> 
                                <!-- <h6 style="color: #26a541;">Get extra <%=couponData[i].discount%>% off upto  ₹ <%=couponData[i].maxRedeemAmount%> on 1 item(s) (price inclusive of cashback/coupon) <span class="d-flex justify-content-end" style="color: #2874f0;">View T&C</span></h6> -->
                                              
                            </div>
                        </div>
                   <%}else if(couponData[i].status =='expired'){%>
                    <div class="card w-100" style="height: 7.25rem; color: silver;">                           
                        <div class="card-body "> 

                            <h5>code:<%=couponData[i].code%></h5>
                            <h6 >Get additional <%=couponData[i].discount%>% Off up to  <%=couponData[i].maxRedeemAmount%><p style="color: silver;">expired<span class="float-right" style="color: #2874f0;">View T&C</span></p></h6> 
                            <!-- <h6 style="color: #26a541;">Get extra <%=couponData[i].discount%>% off upto  ₹ <%=couponData[i].maxRedeemAmount%> on 1 item(s) (price inclusive of cashback/coupon) <span class="d-flex justify-content-end" style="color: #2874f0;">View T&C</span></h6> -->
                                          
                        </div>
                    </div>
                    <%}%>
                        
                    </div>
                    <%}%>
                        <%}%>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
          <!-- <button type="button" class="btn btn-primary">Understood</button> -->
        </div>
      </div>
    </div>
  </div>


                    
                        <% for(let i=0;i<userData.address.length;i++){ %>
                            <div class="alert bg-white  d-flex align-items-center col-12 mb-0 text-dark" role="alert"> 
                            <div class="card w-100" >
                                                        
                                <div class="card-body"> 
                                
                                <!-- <div style="background-color:#f0f0f0;width: 50px; height:17px; font-weight: 500; color:#878787; font-size: 11px;" class="d-flex justify-content-center ">
                                    <p>HOME</p>
                                                                    </div> -->
                                <input type="radio" class="form-check-input " name="radio" id="radio" value="<%=i+1%>" onclick="order()">
                               <span id="name1<%=i+1%>" style="font-weight: 600;"><%=userData.address[i].name%></span>,<span id="mobile1<%=i+1%>"  style="font-weight: 600;"><%=userData.address[i].mobile%></span><br><span id="house1<%=i+1%>"><%=userData.address[i].house%></span>,<span id="street1<%=i+1%>"><%=userData.address[i].street%></span>,
                                        <span id="city1<%=i+1%>"><%=userData.address[i].city%></span><br><span id="district1<%=i+1%>"><%=userData.address[i].district%></span>
                                               <span id="state1<%=i+1%>"><%=userData.address[i].state%></span> 
                                                   <span id="country1<%=i+1%>"><%=userData.address[i].country%></span><br> 
                                                      <span id="pinCode1<%=i+1%>"><%=userData.address[i].pinCode%></span>  
                                          <div class="form-check">
                                           

                                          </div>          
                                </div>
                            </div>
                            </div>
                            <%}%>
                            <%}%>
                                
                        </div>
                    </div>               
            </div>
                  
            <div class="col-lg-4">
                <div class="input-group " >
                    <input type="text" class="form-control border-0 p-4" name="coupon" id="coupon" placeholder="Coupon Code"> 
                    <div class="input-group-append">
                       <button onclick="applyCoupon()" id="applied" class="btn btn-primary">Apply</button><button type="button" class="btn" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                        <span class="material-symbols-outlined " >
                            List
                            </span>
                      </button>
                   </div>
                   
               </div>
               <!-- <p id="message"></p> -->
               <marquee direction="Sidebar"  id="message"></marquee>
               <br>
                <h5 class="section-title position-relative text-uppercase mb-3"><span class="bg-secondary pr-3">Order Total</span></h5>
               
                
                <div class="bg-light p-30 mb-5">
                    
                    <div class="border-bottom">
                        <h6 class="mb-3">Products</h6>
                          <% for(let i=0;i<cartProducts.length;i++){%>
                        <div class="d-flex justify-content-between">
                         
                            <a href="/productdetail?id=<%= productData[i]._id %>" style="text-decoration: none; color: black;"> <span style="display:inline-block;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            max-width: 18ch;"> <%=cartProducts[i].name%></span></a>
                                
                                <p style="color: black;"> &#x20B9; <%=data[i].price%></p>
                        </div>
                         <% }%>
                            
                        
                    </div>
                    <div class="border-bottom pt-3 pb-2">
                        <div class="d-flex justify-content-between mb-3 ">
                            <% let money =0; for(let i=0;i<cartProducts.length;i++){
                                money +=data[i].price;}%>
                            <h6 >Subtotal</h6>
                             <h6>&#x20B9;<%=money%></h6>
                        </div>
                        <div class="d-flex justify-content-between">
                            <h6 class="font-weight-medium">Delivery Charges</h6>
                            <h6 class="font-weight-medium">Free </h6>
                        </div><br>
                        <div class="d-flex justify-content-between">
                            <h6 class="font-weight-medium">Discount Price</h6>
                            <h6 class="font-weight-medium" id="discount">&#x20B9;0</h6>
                        </div>
                    </div>
                    <div class="pt-2">
                        <div class="d-flex justify-content-between mt-2">
                            <% let overAll =0;for(let j=0;j<cartProducts.length;j++){
                                overAll+=data[j].price;}%>
                            <h5>Total</h5>
                            
                            <input id="overAll" name="total" class="border-0 text-danger"  style=" text-align: end; background: transparent; " value="₹ <%=overAll%>" disabled></input>
                            <input type="hidden" name="total" value="<%=overAll%>">
                        </div>
                    </div>
                </div>

                <div class="mb-5">
                    <h5 class="section-title position-relative text-uppercase mb-3"><span class="bg-secondary pr-3">Payment</span></h5>
                    <div class="bg-light p-30">
                        <div class="form-group">
                            <div class="custom-control custom-radio">
                                <input type="radio" class="custom-control-input" name="payment" value="razorpay" id="BHIM UPI">
                                <label class="custom-control-label" for="BHIM UPI">Razorpay</label>
                            </div>
                        </div>
                        
                        <div class="form-group mb-4">
                            <div class="custom-control custom-radio">
                                <input type="radio" class="custom-control-input" name="payment" value="COD" id="cash on delivery">
                                <label class="custom-control-label" for="cash on delivery">Cash on delivery</label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-block btn-primary font-weight-bold py-3" >Place Order</button>
                    </div>
                </div>
            </div>
        </div>
    </form>

   



    <!-- Checkout End -->


    <!-- Footer Start -->
    
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script>
        let price = document.getElementById('overAll').value
        console.log(price);
        function order(){
            
            const addressCheck = document.querySelectorAll('input[name="radio"]:checked')
        
            addressCheck.forEach(radio=>{
                if(radio.checked){              
                        let checkbox = radio.value
                        let name='name1'+checkbox;
                        let mobile='mobile1'+checkbox;
                    
                        let house ='house1'+checkbox;
                        let street ='street1'+checkbox;
                        let city = "city1"+checkbox;
                        let district='district1'+checkbox;
                        let state='state1'+checkbox;
                        let country ='country1'+checkbox;
                        let pinCode12 ='pinCode1'+checkbox;
                        
            

                        document.getElementById('name').value = document.getElementById(name).textContent;
                        document.getElementById('mob').value = document.getElementById(mobile).textContent;
                        
                        document.getElementById('house').value = document.getElementById(house).textContent;
                        document.getElementById('street').value = document.getElementById(street).textContent;
                        document.getElementById('city').value = document.getElementById(city).textContent;
                        document.getElementById('district').value = document.getElementById(district).textContent;
                        document.getElementById('state').value = document.getElementById(state).textContent;
                        document.getElementById('country').value = document.getElementById(country).textContent;
                        document.getElementById('zip').value = document.getElementById(pinCode12).textContent;     
                     

                }
            })
       
 }











        function applyCoupon(){
            let coupon = document.getElementById('coupon').value;
            let message = document.getElementById('message');
           console.log(coupon);
           if(coupon.trim() === ''){
            const Toast = Swal.mixin({
                                toast: true,
                                position: 'top-right',
                                showConfirmButton: false,
                                timer: 2000,
                                timerProgressBar: true,
                                didOpen: (toast) => {
                                    toast.addEventListener('mouseenter', Swal.stopTimer)
                                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                                }
                                })

                                Toast.fire({
                                icon: 'warning',
                                title: 'Please enter coupon Code'
                                })
           }else{
            $.ajax({
                url:`/couponapply/${coupon}`,
                method:'post',
                success:function(response){
                     if(response.success==true){
                    // document.getElementById(``).textContent = response.total;
                     document.getElementById('overAll').value ="₹"+ response.discountedPrice;
                     document.getElementById('discount').innerHTML="₹"+ response.discountAmount;
                    message.innerHTML="Coupon applied ";
                  const disable= document.getElementById('coupon');
                   disable.disabled = true;
                    message.style.color=' #26a541';
                    const cancel = document.getElementById('applied')
                    cancel.innerHTML = "cancel"
                    cancel.addEventListener("click",function(){
                        location.reload();
                    })

                        
                     }else{
                        const input = document.getElementById('coupon');
                        input.value =null;
                        const Toast = Swal.mixin({
                                toast: true,
                                position: 'top-right',
                                showConfirmButton: false,
                                timer: 2000,
                                timerProgressBar: true,
                                didOpen: (toast) => {
                                    toast.addEventListener('mouseenter', Swal.stopTimer)
                                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                                }
                                })

                                Toast.fire({
                                icon: 'warning',
                                title: response.message
                                })
                     }
                }
            })
           }
            
        }



    $('#checkout_form').submit((e)=>{
    e.preventDefault();
    const coupon = document.getElementById('coupon').value;

    $.ajax({
        url: `/checkout`,
        method: 'POST',
        data: $('#checkout_form').serialize()+ '&coupon=' + coupon,
        success: (response) => {
        
            if(response.codSuccess == true) {
            
                location.href ='/orderPage';

            } else{
                razorpayPayment(response.order);
                console.log("online");
            

            }
        },
        error: (error) => {
            console.error(error);
        }
    });
});

function razorpayPayment(order) {
    const options = {
        "key": "rzp_test_VVlOYqS30Y2ZdA", // Enter the Key ID generated from the Dashboard
        "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
        "currency": "INR",
        "name": "LapMania", //your business name
        "description": "Test Transaction",
        "image": "https://example.com/your_logo",
        "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
        "handler": function (response){
            $.ajax({
        url: '/verify-payment',
        data: {
            razorpayP:response.razorpay_payment_id,
            razorpayO:response.razorpay_order_id,
            razorpayS:response.razorpay_signature,
            order_id:order.id
        },
        method: 'POST',
        success: (response) => {
            // alert(response.message)
            location.href ='/orderPage';
            console.log(response,);
            // Update order status
        },
        error: (error) => {
            console.error(error);
        }
    });
        },
        "prefill": {
            "name": "Gaurav Kumar", //your customer's name
            "email": "gaurav.kumar@example.com",
            "contact": "9000090000"
        },
        "notes": {
            "address": "Razorpay Corporate Office"
        },
        "theme": {
            "color": "#2874f0"
        }
    };
    const rzp1 = new Razorpay(options);
    rzp1.open();
}


   



        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js" integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V" crossorigin="anonymous"></script>
    
<%-include('../layouts/websitefooter.ejs') %>